#include "thingino.h"
#include "flash_descriptor.h"
#include <string.h>
#include <unistd.h>

// The complete 972-byte flash descriptor captured from factory tool
// This is for WIN25Q128JVSQ (16MB NOR flash)
static const uint8_t flash_descriptor_win25q128[FLASH_DESCRIPTOR_SIZE] = {
    // Header (0x00-0x1F)
    0x00, 0x47, 0x42, 0x44, 0x14, 0x00, 0x00, 0x00,  // Magic "GBD\x00", count=20
    0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,  // Flags
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // More flags
    0x00, 0x00, 0x00, 0x00, 0x49, 0x4C, 0x4F, 0x50,  // Magic "ILOP"
    
    // Policy header (0x20-0xC7)
    0xA4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // Policy size = 164
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    
    // Flash config 1 (0xC8-0x1FF)
    0x00, 0x43, 0x46, 0x53, 0xFC, 0x02, 0x00, 0x00,  // "SFC\x00"
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x6E, 0x6F, 0x72, 0x00, 0x01, 0x00, 0x00, 0x00,  // "nor\x00"
    0x57, 0x49, 0x4E, 0x32, 0x35, 0x51, 0x31, 0x32,  // "WIN25Q128JVSQ"
    0x38, 0x4A, 0x56, 0x53, 0x51, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x40, 0xEF, 0x00, 0x03, 0x00, 0x00, 0x03,  // Flash ID: EF4018
    0x00, 0x00, 0x6B, 0x00, 0x08, 0x03, 0x05, 0x00,  // Commands
    0x02, 0x00, 0x00, 0x03, 0x00, 0x00, 0x32, 0x00,
    0x00, 0x03, 0x05, 0x00, 0x52, 0x00, 0x00, 0x03,
    0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xB7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x00,
    0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x35, 0x00,
    0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x05, 0x00,
    0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00,
    0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00,
    0x60, 0x00, 0x00, 0x00, 0x66, 0x75, 0x6C, 0x6C,  // "full"
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    // Padding to 0x350 (rest is zeros)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

    // Flash config 2 (0x350-0x3CB)
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,  // Flags
    0x57, 0x49, 0x4E, 0x32, 0x35, 0x51, 0x31, 0x32,  // "WIN25Q128JVSQ" again
    0x38, 0x4A, 0x56, 0x53, 0x51, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x40, 0xEF, 0x00, 0x03, 0x00, 0x00, 0x03,  // Flash ID: EF4018 again
    0x00, 0x00, 0x6B, 0x00, 0x08, 0x03, 0x05, 0x00,
    0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0xB7, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x31, 0x00, 0x01, 0x01,
    0x01, 0x01, 0x00, 0x00, 0x35, 0x00, 0x01, 0x01,
    0x01, 0x01, 0x00, 0x00, 0x05, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x80, 0x00, 0x00,  // End at 0x3CC (972 bytes total)
};

/**
 * Create flash descriptor for WIN25Q128JVSQ
 */
int flash_descriptor_create_win25q128(uint8_t *buffer) {
    if (!buffer) {
        return -1;
    }

    // Copy the pre-defined descriptor
    memcpy(buffer, flash_descriptor_win25q128, FLASH_DESCRIPTOR_SIZE);

    return 0;
}

/**
 * Send flash descriptor to device
 */
thingino_error_t flash_descriptor_send(usb_device_t *device, const uint8_t *descriptor) {
    if (!device || !descriptor) {
        return THINGINO_ERROR_INVALID_PARAMETER;
    }

    DEBUG_PRINT("Sending flash descriptor (972 bytes)...\n");

    // Step 1: Send control transfer with 40-byte header (bRequest=0x14)
    DEBUG_PRINT("Step 1: Sending control transfer (bRequest=0x14, 40 bytes)...\n");
    int result = libusb_control_transfer(
        device->handle,
        0x40,           // bmRequestType: Host-to-device, Vendor, Device
        0x14,           // bRequest: 20 (0x14)
        0,              // wValue
        0,              // wIndex
        (unsigned char*)descriptor,  // First 40 bytes
        0x28,           // wLength: 40 bytes
        5000            // timeout: 5 seconds
    );

    if (result != 0x28) {
        printf("[ERROR] Control transfer failed: %d (%s)\n", result, libusb_error_name(result));
        return THINGINO_ERROR_TRANSFER_FAILED;
    }

    DEBUG_PRINT("Control transfer successful\n");

    // Step 2: Wait 100ms for device to process
    usleep(100000);

    // Step 3: Send full 972-byte structure via bulk OUT to endpoint 0x01
    DEBUG_PRINT("Step 2: Sending bulk OUT transfer (972 bytes to endpoint 0x01)...\n");
    int transferred = 0;
    result = libusb_bulk_transfer(
        device->handle,
        0x01,           // endpoint: 0x01 (OUT)
        (unsigned char*)descriptor,
        FLASH_DESCRIPTOR_SIZE,  // 972 bytes
        &transferred,
        5000            // timeout: 5 seconds
    );

    if (result != 0) {
        printf("[ERROR] Bulk transfer failed: %d (%s)\n", result, libusb_error_name(result));
        return THINGINO_ERROR_TRANSFER_FAILED;
    }

    if (transferred != FLASH_DESCRIPTOR_SIZE) {
        printf("[ERROR] Bulk transfer incomplete: %d/%d bytes\n", transferred, FLASH_DESCRIPTOR_SIZE);
        return THINGINO_ERROR_TRANSFER_FAILED;
    }

    DEBUG_PRINT("Bulk transfer successful: %d bytes\n", transferred);

    // Step 4: Wait for device to process the descriptor
    usleep(100000);

    DEBUG_PRINT("Flash descriptor sent successfully\n");

    return THINGINO_SUCCESS;
}

